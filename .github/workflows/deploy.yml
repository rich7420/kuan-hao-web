name: Build and Deploy to Cloud Run

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: kuan-hao
  REGION: asia-east1
  BACKEND_SERVICE: backend-service
  FRONTEND_SERVICE: frontend-service
  CLOUD_SQL_INSTANCE: kuan-hao-db
  DB_NAME: kuan_hao_web
  DB_USER: postgres
  # Artifact Registry host for the region (replaces gcr.io)
  ARTIFACT_REGISTRY: asia-east1-docker.pkg.dev

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    outputs:
      connection_name: ${{ steps.connection.outputs.connection_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Enable APIs
        run: |
          gcloud services enable sqladmin.googleapis.com run.googleapis.com artifactregistry.googleapis.com --project=$PROJECT_ID --quiet

      - name: Create Artifact Registry Repo
        run: |
          if ! gcloud artifacts repositories describe my-repo --location=$REGION --project=$PROJECT_ID &>/dev/null; then
            echo "Creating Artifact Registry repository..."
            gcloud artifacts repositories create my-repo \
              --repository-format=docker \
              --location=$REGION \
              --description="Docker repository" \
              --project=$PROJECT_ID \
              --quiet
          else
            echo "Artifact Registry repository already exists."
          fi

      - name: Create Cloud SQL instance if not exists
        env:
          ROOT_PASSWORD: ${{ secrets.CLOUD_SQL_PASSWORD }}
        run: |
          if ! gcloud sql instances describe $CLOUD_SQL_INSTANCE --project=$PROJECT_ID &>/dev/null; then
            echo "Creating Cloud SQL instance..."
            gcloud sql instances create $CLOUD_SQL_INSTANCE \
              --project=$PROJECT_ID \
              --database-version=POSTGRES_15 \
              --tier=db-f1-micro \
              --region=$REGION \
              --root-password="$ROOT_PASSWORD" \
              --quiet
          else
            echo "Instance $CLOUD_SQL_INSTANCE already exists."
          fi

      - name: Create database if not exists
        run: |
          if ! gcloud sql databases list --instance=$CLOUD_SQL_INSTANCE --project=$PROJECT_ID --format="value(name)" | grep -q "^${DB_NAME}$"; then
            echo "Creating database $DB_NAME..."
            gcloud sql databases create $DB_NAME --instance=$CLOUD_SQL_INSTANCE --project=$PROJECT_ID --quiet
          else
            echo "Database $DB_NAME already exists."
          fi

      - name: Set connection name
        id: connection
        run: |
          echo "connection_name=$PROJECT_ID:$REGION:$CLOUD_SQL_INSTANCE" >> "$GITHUB_OUTPUT"

  deploy-backend:
    needs: setup-environment
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.backend-url.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

      - name: Build and Push Backend
        working-directory: ./backend
        run: |
          IMAGE_TAG="$ARTIFACT_REGISTRY/$PROJECT_ID/my-repo/$BACKEND_SERVICE:${{ github.sha }}"
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

      - name: Deploy Backend
        run: |
          IMAGE_TAG="$ARTIFACT_REGISTRY/$PROJECT_ID/my-repo/$BACKEND_SERVICE:${{ github.sha }}"
          CONN_NAME="$PROJECT_ID:$REGION:$CLOUD_SQL_INSTANCE"
          DB_URL="postgres://$DB_USER:${{ secrets.CLOUD_SQL_PASSWORD }}@localhost/$DB_NAME?host=/cloudsql/$CONN_NAME"

          echo "Deploying to Cloud Run with connection: $CONN_NAME"

          gcloud run deploy $BACKEND_SERVICE \
            --image $IMAGE_TAG \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances $CONN_NAME \
            --set-env-vars "DATABASE_URL=$DB_URL,RUST_LOG=info" \
            --startup-probe=tcpSocket.port=8080,initialDelaySeconds=30,failureThreshold=6,timeoutSeconds=5,periodSeconds=10

      - name: Get Backend URL
        id: backend-url
        run: |
          URL=$(gcloud run services describe $BACKEND_SERVICE --region=$REGION --format='value(status.url)')
          echo "url=$URL" >> "$GITHUB_OUTPUT"

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_CREDENTIALS }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

      - name: Build and Push Frontend
        working-directory: ./frontend
        env:
          BACKEND_URL: ${{ needs.deploy-backend.outputs.backend_url }}
        run: |
          IMAGE_TAG="$ARTIFACT_REGISTRY/$PROJECT_ID/my-repo/$FRONTEND_SERVICE:${{ github.sha }}"
          docker build \
            --build-arg NEXT_PUBLIC_API_URL=$BACKEND_URL \
            -t $IMAGE_TAG .
          docker push $IMAGE_TAG

      - name: Deploy Frontend
        run: |
          IMAGE_TAG="$ARTIFACT_REGISTRY/$PROJECT_ID/my-repo/$FRONTEND_SERVICE:${{ github.sha }}"
          gcloud run deploy $FRONTEND_SERVICE \
            --image $IMAGE_TAG \
            --region $REGION \
            --platform managed \
            --allow-unauthenticated
